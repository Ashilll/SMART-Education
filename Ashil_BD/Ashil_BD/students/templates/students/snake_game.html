{% extends 'students/base.html' %}

{% block page_title %}üéÆ –ó–º–µ–π–∫–∞{% endblock %}

{% block content %}
<div class="game-container">
    <div class="game-header text-center mb-4">
        <h1 class="display-4">üêç –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ó–º–µ–π–∫–∞</h1>
        <p class="lead">–°–æ–±–∏—Ä–∞–π —è–±–ª–æ–∫–∏, —Å—Ç–∞–Ω–æ–≤–∏—Å—å –¥–ª–∏–Ω–Ω–µ–µ –∏ —Å—Ç–∞–≤—å —Ä–µ–∫–æ—Ä–¥—ã!</p>
    </div>
    
    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–≥—Ä–∞ -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-body p-3">
                    <div class="text-center mb-3">
                        <!-- –ò–∑–º–µ–Ω–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω ID –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
                        <div id="canvas-container">
                            <canvas id="gameCanvas" width="600" height="400">
                                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Canvas. –û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä.
                            </canvas>
                        </div>
                    </div>
                    
                    <div class="game-controls text-center">
                        <button id="startBtn" class="btn btn-success btn-lg">
                            <i class="bi bi-play-fill"></i> –°—Ç–∞—Ä—Ç
                        </button>
                        <button id="pauseBtn" class="btn btn-warning btn-lg">
                            <i class="bi bi-pause-fill"></i> –ü–∞—É–∑–∞
                        </button>
                        <button id="restartBtn" class="btn btn-secondary btn-lg">
                            <i class="bi bi-arrow-clockwise"></i> –ó–∞–Ω–æ–≤–æ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-bar-chart-fill"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-card bg-success text-white">
                            <div class="stat-icon">üèÜ</div>
                            <div class="stat-info">
                                <h5>–°—á–µ—Ç</h5>
                                <p class="stat-value" id="score">0</p>
                            </div>
                        </div>
                        <div class="stat-card bg-info text-white">
                            <div class="stat-icon">üìè</div>
                            <div class="stat-info">
                                <h5>–î–ª–∏–Ω–∞</h5>
                                <p class="stat-value" id="length">3</p>
                            </div>
                        </div>
                        <div class="stat-card bg-warning text-white">
                            <div class="stat-icon">üçé</div>
                            <div class="stat-info">
                                <h5>–Ø–±–ª–æ–∫–∏</h5>
                                <p class="stat-value" id="apples">0</p>
                            </div>
                        </div>
                        <div class="stat-card bg-danger text-white">
                            <div class="stat-icon">‚ö°</div>
                            <div class="stat-info">
                                <h5>–°–∫–æ—Ä–æ—Å—Ç—å</h5>
                                <p class="stat-value" id="speed">1</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-trophy-fill"></i> –†–µ–∫–æ—Ä–¥—ã</h4>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <h2 id="highScore">0</h2>
                        <p class="text-muted">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                        <button id="resetHighScore" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0"><i class="bi bi-keyboard-fill"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h4>
                </div>
                <div class="card-body">
                    <div class="controls-grid">
                        <div class="control-item"><kbd>‚Üë</kbd> <kbd>W</kbd> –í–≤–µ—Ä—Ö</div>
                        <div class="control-item"><kbd>‚Üì</kbd> <kbd>S</kbd> –í–Ω–∏–∑</div>
                        <div class="control-item"><kbd>‚Üê</kbd> <kbd>A</kbd> –í–ª–µ–≤–æ</div>
                        <div class="control-item"><kbd>‚Üí</kbd> <kbd>D</kbd> –í–ø—Ä–∞–≤–æ</div>
                        <div class="control-item"><kbd>–ü—Ä–æ–±–µ–ª</kbd> –ü–∞—É–∑–∞</div>
                        <div class="control-item"><kbd>ESC</kbd> –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0"><i class="bi bi-info-circle-fill"></i> –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> –£–ø—Ä–∞–≤–ª—è–π –∑–º–µ–π–∫–æ–π –∫–ª–∞–≤–∏—à–∞–º–∏</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> –°–æ–±–∏—Ä–∞–π –∫—Ä–∞—Å–Ω—ã–µ —è–±–ª–æ–∫–∏ üçé</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success"></i> –ö–∞–∂–¥–æ–µ —è–±–ª–æ–∫–æ = +10 –æ—á–∫–æ–≤</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> –ù–µ –≤—Ä–µ–∑–∞–π—Å—è –≤ —Å—Ç–µ–Ω—ã</li>
                        <li class="mb-2"><i class="bi bi-x-circle text-danger"></i> –ù–µ –≤—Ä–µ–∑–∞–π—Å—è –≤ —Å–µ–±—è</li>
                        <li class="mb-2"><i class="bi bi-lightning-charge text-warning"></i> –° –∫–∞–∂–¥—ã–º 5-–º —è–±–ª–æ–∫–æ–º —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* –°–¢–ò–õ–ò –î–õ–Ø –ò–ì–†–´ */
.game-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
}

#canvas-container {
    display: inline-block;
    border: 3px solid #4CAF50;
    border-radius: 10px;
    overflow: hidden;
    background: #111;
}

#gameCanvas {
    display: block; /* –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ–¥ canvas */
    max-width: 100%;
    height: auto;
}

.game-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.game-controls button {
    min-width: 120px;
    padding: 12px 20px;
    font-size: 1.1rem;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.stat-card {
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 0;
}

/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
.controls-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.control-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
}

.control-item kbd {
    background: #333;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    margin: 0 5px;
}

/* –°–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä—ã */
.game-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    z-index: 10;
    min-width: 300px;
    border: 3px solid #4CAF50;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .stats-grid, .controls-grid {
        grid-template-columns: 1fr;
    }
    
    .game-controls {
        flex-direction: column;
    }
    
    .game-controls button {
        width: 100%;
    }
    
    #canvas-container {
        width: 100%;
    }
    
    #gameCanvas {
        width: 100% !important;
        height: 300px !important;
    }
}
</style>

<script>
// ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
const config = {
    cellSize: 20,
    initialSpeed: 150,  // –º—Å –Ω–∞ —Ö–æ–¥ (–±–æ–ª—å—à–µ = –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
    speedIncrease: 10,  // –Ω–∞ —Å–∫–æ–ª—å–∫–æ —É—Å–∫–æ—Ä—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —è–±–ª–æ–∫
    minSpeed: 50,       // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
    initialLength: 3,
    applePoints: 10,
    highScoreKey: 'snakeHighScore'
};

// ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
let canvas, ctx;
let snake = [];
let apple = {};
let direction = 'right';
let nextDirection = 'right';
let gameInterval;
let isPaused = false;
let isGameOver = false;
let score = 0;
let applesCollected = 0;
let currentSpeed = config.initialSpeed;
let gameStarted = false;
let appleEaten = false; // –§–ª–∞–≥ —Å—ä–µ–¥–µ–Ω–∏—è —è–±–ª–æ–∫–∞

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∫–æ—Ä–¥
    loadHighScore();
    
    // –ö–Ω–æ–ø–∫–∏
    document.getElementById('startBtn').addEventListener('click', startGame);
    document.getElementById('pauseBtn').addEventListener('click', togglePause);
    document.getElementById('restartBtn').addEventListener('click', resetGame);
    document.getElementById('resetHighScore').addEventListener('click', resetHighScore);
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    document.addEventListener('keydown', handleKeyPress);
    
    // –ù–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
    initGame();
    draw();
    
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–∞—Ä—Ç–∞
    showMessage('–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É');
});

// ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
function initGame() {
    // –°–æ–∑–¥–∞–µ–º –∑–º–µ–π–∫—É
    snake = [];
    for (let i = config.initialLength - 1; i >= 0; i--) {
        snake.push({ x: i + 5, y: 10 }); // –ù–∞—á–∏–Ω–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–∞–≤–µ–µ
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤–æ–µ —è–±–ª–æ–∫–æ
    generateApple();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    score = 0;
    applesCollected = 0;
    currentSpeed = config.initialSpeed;
    direction = 'right';
    nextDirection = 'right';
    isGameOver = false;
    isPaused = false;
    gameStarted = false;
    appleEaten = false;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
}

function startGame() {
    if (isGameOver) {
        resetGame();
        return;
    }
    
    if (!gameStarted) {
        gameStarted = true;
        document.getElementById('startBtn').innerHTML = '<i class="bi bi-play-fill"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        document.getElementById('startBtn').classList.remove('btn-success');
        document.getElementById('startBtn').classList.add('btn-primary');
    }
    
    isPaused = false;
    
    if (gameInterval) {
        clearInterval(gameInterval);
    }
    
    gameInterval = setInterval(gameLoop, currentSpeed);
    hideMessage();
}

function gameLoop() {
    if (isPaused || isGameOver) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    direction = nextDirection;
    
    // –î–≤–∏–≥–∞–µ–º –∑–º–µ–π–∫—É
    moveSnake();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    if (checkCollision()) {
        gameOver();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—ä–µ–ª–∏ –ª–∏ —è–±–ª–æ–∫–æ
    if (snake[0].x === apple.x && snake[0].y === apple.y) {
        eatApple();
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    draw();
}

function draw() {
    // –û—á–∏—â–∞–µ–º —Ö–æ–ª—Å—Ç
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
    drawGrid();
    
    // –†–∏—Å—É–µ–º –∑–º–µ–π–∫—É
    snake.forEach((segment, index) => {
        // –ì–æ–ª–æ–≤–∞ –∑–µ–ª–µ–Ω–µ–µ
        if (index === 0) {
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(
                segment.x * config.cellSize,
                segment.y * config.cellSize,
                config.cellSize,
                config.cellSize
            );
            
            // –ì–ª–∞–∑–∞
            ctx.fillStyle = 'white';
            let eyeSize = 3;
            let offset = 5;
            
            // –ì–ª–∞–∑–∞ —Å–º–æ—Ç—Ä—è—Ç –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
            if (direction === 'right') {
                ctx.fillRect(segment.x * config.cellSize + config.cellSize - offset, 
                           segment.y * config.cellSize + offset, eyeSize, eyeSize);
                ctx.fillRect(segment.x * config.cellSize + config.cellSize - offset, 
                           segment.y * config.cellSize + config.cellSize - offset - eyeSize, eyeSize, eyeSize);
            } else if (direction === 'left') {
                ctx.fillRect(segment.x * config.cellSize + offset, 
                           segment.y * config.cellSize + offset, eyeSize, eyeSize);
                ctx.fillRect(segment.x * config.cellSize + offset, 
                           segment.y * config.cellSize + config.cellSize - offset - eyeSize, eyeSize, eyeSize);
            } else if (direction === 'up') {
                ctx.fillRect(segment.x * config.cellSize + offset, 
                           segment.y * config.cellSize + offset, eyeSize, eyeSize);
                ctx.fillRect(segment.x * config.cellSize + config.cellSize - offset - eyeSize, 
                           segment.y * config.cellSize + offset, eyeSize, eyeSize);
            } else if (direction === 'down') {
                ctx.fillRect(segment.x * config.cellSize + offset, 
                           segment.y * config.cellSize + config.cellSize - offset, eyeSize, eyeSize);
                ctx.fillRect(segment.x * config.cellSize + config.cellSize - offset - eyeSize, 
                           segment.y * config.cellSize + config.cellSize - offset, eyeSize, eyeSize);
            }
        } else {
            // –¢–µ–ª–æ —Å–≤–µ—Ç–ª–µ–µ
            ctx.fillStyle = '#8BC34A';
            ctx.fillRect(
                segment.x * config.cellSize,
                segment.y * config.cellSize,
                config.cellSize,
                config.cellSize
            );
            
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
            ctx.fillStyle = '#7CB342';
            ctx.fillRect(
                segment.x * config.cellSize,
                segment.y * config.cellSize,
                config.cellSize,
                2
            );
        }
    });
    
    // –†–∏—Å—É–µ–º —è–±–ª–æ–∫–æ
    ctx.fillStyle = '#FF5252';
    ctx.beginPath();
    ctx.arc(
        apple.x * config.cellSize + config.cellSize / 2,
        apple.y * config.cellSize + config.cellSize / 2,
        config.cellSize / 2,
        0,
        Math.PI * 2
    );
    ctx.fill();
    
    // –°—Ç–µ–±–µ–ª—å —è–±–ª–æ–∫–∞
    ctx.fillStyle = '#8BC34A';
    ctx.fillRect(
        apple.x * config.cellSize + config.cellSize / 2 - 1,
        apple.y * config.cellSize + 2,
        2,
        5
    );
    
    // –õ–∏—Å—Ç–∏–∫
    ctx.fillStyle = '#4CAF50';
    ctx.beginPath();
    ctx.moveTo(apple.x * config.cellSize + config.cellSize / 2 + 2, apple.y * config.cellSize + 2);
    ctx.lineTo(apple.x * config.cellSize + config.cellSize / 2 + 8, apple.y * config.cellSize - 2);
    ctx.lineTo(apple.x * config.cellSize + config.cellSize / 2 + 4, apple.y * config.cellSize + 2);
    ctx.fill();
}

function drawGrid() {
    ctx.strokeStyle = '#222';
    ctx.lineWidth = 0.5;
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    for (let x = 0; x <= canvas.width; x += config.cellSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    
    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    for (let y = 0; y <= canvas.height; y += config.cellSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }
}

function generateApple() {
    let appleOnSnake;
    do {
        appleOnSnake = false;
        apple = {
            x: Math.floor(Math.random() * (canvas.width / config.cellSize)),
            y: Math.floor(Math.random() * (canvas.height / config.cellSize))
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ –∑–º–µ–π–∫–µ –ª–∏ —è–±–ª–æ–∫–æ
        for (const segment of snake) {
            if (segment.x === apple.x && segment.y === apple.y) {
                appleOnSnake = true;
                break;
            }
        }
    } while (appleOnSnake);
}

function moveSnake() {
    const head = { ...snake[0] };
    
    // –î–≤–∏–≥–∞–µ–º –≥–æ–ª–æ–≤—É
    switch (direction) {
        case 'up': head.y--; break;
        case 'down': head.y++; break;
        case 'left': head.x--; break;
        case 'right': head.x++; break;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≥–æ–ª–æ–≤—É
    snake.unshift(head);
    
    // –£–î–ê–õ–Ø–ï–ú –•–í–û–°–¢ –¢–û–õ–¨–ö–û –ï–°–õ–ò –ù–ï –°–™–ï–õ–ò –Ø–ë–õ–û–ö–û
    // –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ - –∑–º–µ–π–∫–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞—Å—Ç–∏!
    if (!appleEaten) {
        snake.pop();
    } else {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∑–º–µ–π–∫–∞ –≤—ã—Ä–æ—Å–ª–∞
        appleEaten = false;
    }
}

function eatApple() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —è–±–ª–æ–∫–æ —Å—ä–µ–¥–µ–Ω–æ
    appleEaten = true;
    score += config.applePoints;
    applesCollected++;
    
    // –£—Å–∫–æ—Ä—è–µ–º –∏–≥—Ä—É –∫–∞–∂–¥—ã–µ 5 —è–±–ª–æ–∫
    if (applesCollected % 5 === 0 && currentSpeed > config.minSpeed) {
        currentSpeed -= config.speedIncrease;
        clearInterval(gameInterval);
        gameInterval = setInterval(gameLoop, currentSpeed);
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —è–±–ª–æ–∫–æ
    generateApple();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats();
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç
    playAppleSound();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è —Å—ä–µ–¥–µ–Ω–∏—è
    animateAppleEaten();
}

function animateAppleEaten() {
    // –ú–∏–≥–∞–Ω–∏–µ —è—á–µ–π–∫–∏ –≥–¥–µ –±—ã–ª–æ —è–±–ª–æ–∫–æ
    let blinkCount = 0;
    const blinkInterval = setInterval(() => {
        const x = apple.x * config.cellSize;
        const y = apple.y * config.cellSize;
        
        if (blinkCount % 2 === 0) {
            ctx.fillStyle = '#FFD700';
        } else {
            ctx.fillStyle = '#FF5252';
        }
        
        ctx.fillRect(x, y, config.cellSize, config.cellSize);
        
        blinkCount++;
        if (blinkCount > 3) {
            clearInterval(blinkInterval);
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            draw();
        }
    }, 100);
}

function playAppleSound() {
    try {
        // –ü—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.2;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        console.log('–ó–≤—É–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    }
}

function checkCollision() {
    const head = snake[0];
    
    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å–æ —Å—Ç–µ–Ω–∞–º–∏
    if (head.x < 0 || head.x >= canvas.width / config.cellSize ||
        head.y < 0 || head.y >= canvas.height / config.cellSize) {
        return true;
    }
    
    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Å–æ–±–æ–π (–Ω–∞—á–∏–Ω–∞–µ–º —Å 1, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≥–æ–ª–æ–≤—É —Å –≥–æ–ª–æ–≤–æ–π)
    for (let i = 1; i < snake.length; i++) {
        if (head.x === snake[i].x && head.y === snake[i].y) {
            return true;
        }
    }
    
    return false;
}

function gameOver() {
    isGameOver = true;
    clearInterval(gameInterval);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥
    saveHighScore();
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    showMessage(
        `–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê!<br><br>
        –°—á–µ—Ç: <strong>${score}</strong><br>
        –î–ª–∏–Ω–∞ –∑–º–µ–π–∫–∏: <strong>${snake.length}</strong><br>
        –°—ä–µ–¥–µ–Ω–æ —è–±–ª–æ–∫: <strong>${applesCollected}</strong><br><br>
        –ù–∞–∂–º–∏—Ç–µ "–ó–∞–Ω–æ–≤–æ" –¥–ª—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã`
    );
}

function togglePause() {
    if (!gameStarted || isGameOver) return;
    
    isPaused = !isPaused;
    const pauseBtn = document.getElementById('pauseBtn');
    
    if (isPaused) {
        clearInterval(gameInterval);
        pauseBtn.innerHTML = '<i class="bi bi-play-fill"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        pauseBtn.classList.remove('btn-warning');
        pauseBtn.classList.add('btn-success');
        
        showMessage('–ü–ê–£–ó–ê<br><br>–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" —á—Ç–æ–±—ã –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å');
    } else {
        gameInterval = setInterval(gameLoop, currentSpeed);
        pauseBtn.innerHTML = '<i class="bi bi-pause-fill"></i> –ü–∞—É–∑–∞';
        pauseBtn.classList.remove('btn-success');
        pauseBtn.classList.add('btn-warning');
        hideMessage();
    }
}

// ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
function updateStats() {
    document.getElementById('score').textContent = score;
    document.getElementById('length').textContent = snake.length;
    document.getElementById('apples').textContent = applesCollected;
    
    // –í—ã—á–∏—Å–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–∫–æ—Ä–æ—Å—Ç–∏ (1 = –Ω–∞—á–∞–ª—å–Ω–∞—è, –±–æ–ª—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ)
    const speedLevel = Math.max(1, Math.round((config.initialSpeed - currentSpeed) / config.speedIncrease) + 1);
    document.getElementById('speed').textContent = speedLevel;
    
    document.getElementById('highScore').textContent = localStorage.getItem(config.highScoreKey) || 0;
}

function handleKeyPress(e) {
    switch (e.key) {
        case 'ArrowUp':
        case 'w':
        case 'W':
            if (direction !== 'down') nextDirection = 'up';
            e.preventDefault();
            break;
        case 'ArrowDown':
        case 's':
        case 'S':
            if (direction !== 'up') nextDirection = 'down';
            e.preventDefault();
            break;
        case 'ArrowLeft':
        case 'a':
        case 'A':
            if (direction !== 'right') nextDirection = 'left';
            e.preventDefault();
            break;
        case 'ArrowRight':
        case 'd':
        case 'D':
            if (direction !== 'left') nextDirection = 'right';
            e.preventDefault();
            break;
        case ' ':
            if (gameStarted) togglePause();
            e.preventDefault();
            break;
        case 'Escape':
            resetGame();
            e.preventDefault();
            break;
    }
}

function loadHighScore() {
    const highScore = localStorage.getItem(config.highScoreKey) || 0;
    document.getElementById('highScore').textContent = highScore;
}

function saveHighScore() {
    const currentHighScore = parseInt(localStorage.getItem(config.highScoreKey) || 0);
    if (score > currentHighScore) {
        localStorage.setItem(config.highScoreKey, score);
        document.getElementById('highScore').textContent = score;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ä–µ–∫–æ—Ä–¥–∞
        const highScoreElement = document.getElementById('highScore');
        highScoreElement.style.color = '#FFD700';
        highScoreElement.style.transform = 'scale(1.2)';
        
        setTimeout(() => {
            highScoreElement.style.color = '';
            highScoreElement.style.transform = '';
        }, 1000);
    }
}

function resetGame() {
    clearInterval(gameInterval);
    initGame();
    draw();
    document.getElementById('startBtn').innerHTML = '<i class="bi bi-play-fill"></i> –°—Ç–∞—Ä—Ç';
    document.getElementById('startBtn').classList.remove('btn-primary');
    document.getElementById('startBtn').classList.add('btn-success');
    gameStarted = false;
    hideMessage();
}

function resetHighScore() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥?')) {
        localStorage.removeItem(config.highScoreKey);
        document.getElementById('highScore').textContent = '0';
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
function showMessage(text) {
    let messageDiv = document.getElementById('gameMessage');
    if (!messageDiv) {
        messageDiv = document.createElement('div');
        messageDiv.id = 'gameMessage';
        messageDiv.className = 'game-message';
        document.getElementById('canvas-container').appendChild(messageDiv);
    }
    messageDiv.innerHTML = text;
    messageDiv.style.display = 'block';
}

function hideMessage() {
    const messageDiv = document.getElementById('gameMessage');
    if (messageDiv) {
        messageDiv.style.display = 'none';
    }
}
</script>
{% endblock %}